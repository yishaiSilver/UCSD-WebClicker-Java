/**
 * This is the highest level of this program. This interfaces with
 * Raspberry Pi HID device and controls a display, thus allowing
 * the instructor to hide and display the chart of students' responses. 
 * 
 * @author Yishai
 * @version 1.0
 * @since 2019-08-19
 */
import java.util.Arrays;
import java.util.List;

import purejavahidapi.*;

public class USBController {
	
	//Ints and their associated answers
	public static final int ANSWER_A = 81;
	public static final int ANSWER_B = 82;
	public static final int ANSWER_C = 83;
	public static final int ANSWER_D = 84;
	public static final int ANSWER_E = 85;
	
	//Answers
	public static final String A = "A";
	public static final String B = "B";
	public static final String C = "C";
	public static final String D = "D";
	public static final String E = "E";
	
	//Bytes for commands
	public static final byte BYTE_OPEN = (byte)0xAA;
	public static final byte BYTE_CLOSE = (byte)0xBB;
	public static final byte BYTE_NEXT_QUESTION = (byte)0xCC;
	public static final byte BYTE_SCREENSHOT = (byte)0xD1;
	public static final byte BYTE_SAVE_ALL_SCREENSHOTS = (byte)0xD2;
	public static final byte BYTE_RESPONSE_ONE = (byte)0x02;
	public static final byte BYTE_RESPONSE_TWO = (byte)0x30;
	
	//PiClicker VID and PID
	public static final short PICLICKER_VID = (short)0x1881;
	public static final short PICLICKER_PID = (short)0x0150;
	
	public static final byte[] START_POLL = new byte[] {0x01, 0x19, 0x66, 0x00, 0x00, 0x00, 0x00, 
			0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
			0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
			0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
			0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00};
	
	public static final byte[] STOP_POLL = new byte[] {0x01, 0x12, 0x00, 0x00, 0x00, 0x00, 0x00, 
			0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
			0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
			0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
			0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00};
	
	public static final byte[] PACKET_0112aa00 = new byte[] {0x01, 0x12, (byte) 0xaa, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00};
	public static final byte[] PACKET_01110000 = new byte[] {0x01, 0x11, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00};
	public static final byte[] PACKET_01120000 = new byte[] {0x01, 0x12, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00};
	public static final byte[] PACKET_01133030 = new byte[] {0x01, 0x13, 0x30, 0x30, 0x3a, 0x30, 0x33, 0x20, 0x4e, 0x55, 0x4d, 0x20, 0x20, 0x20, 0x20, 0x20, 0x30, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00};
	public static final byte[] PACKET_01150000 = new byte[] {0x01, 0x15, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00};
	public static final byte[] PACKET_01160000 = new byte[] {0x01, 0x16, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00};
	public static final byte[] PACKET_011e0000 = new byte[] {0x01, 0x1e, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00};
	public static final byte[] PACKET_0132aa00 = new byte[] {0x01, 0x32, (byte) 0xaa, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00};
	public static final byte[] PACKET_011eaa00 = new byte[] {0x01, 0x1e, (byte) 0xaa, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00};
	public static final byte[] PACKET_01150057 = new byte[] {0x01, 0x15, 0x00, 0x57, 0x05, 0x04, 0x21, 0x43, 0x01, 0x00, 0x66, 0x00, 0x07, 0x00, 0x04, 0x12, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00};
	public static final byte[] PACKET_01220000 = new byte[] {0x01, 0x22, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00};
	public static final byte[] PACKET_0110aa00 = new byte[] {0x01, 0x10, (byte) 0xaa, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00};
	public static final byte[] PACKET_0111aa00 = new byte[] {0x01, 0x11, (byte) 0xaa, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00};
	public static final byte[] PACKET_0119aa00 = new byte[] {0x01, 0x19, (byte) 0xaa, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00};
	public static final byte[] PACKET_0116aa00 = new byte[] {0x01, 0x16, (byte) 0xaa, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00};
	public static final byte[] PACKET_0129aa00 = new byte[] {0x01, 0x29, (byte) 0xaa, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00};
	public static final byte[] PACKET_012aaa00 = new byte[] {0x01, 0x2a, (byte) 0xaa, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00};
	public static final byte[] PACKET_022c0000 = new byte[] {0x02, 0x2c, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00};
	public static final byte[] PACKET_01102141 = new byte[] {0x01, 0x10, 0x21, 0x41, 0x60, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00};
	public static final byte[] PACKET_01298080 = new byte[] {0x01, 0x29, (byte) 0x80, (byte) 0x80, (byte) 0x80, (byte) 0x80, (byte) 0x80, (byte) 0x80, (byte) 0x80, (byte) 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01};
	public static final byte[] PACKET_012a2141 = new byte[] {01, 0x2a, 0x21, 0x41, 0x05, 0x65, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x06};
	public static final byte[] PACKET_01320004 = new byte[] {01, 0x32, 0x00, 0x04, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x76};
	public static final byte[] PACKET_01136943 = new byte[] {01, 0x13, 0x69, 0x43, 0x6c, 0x69, 0x63, 0x6b, 0x65, 0x72, 0x20, 0x53, 0x79, 0x73, 0x74, 0x65, 0x6d, 0x20, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x06};
	public static final byte[] PACKET_01142020 = new byte[] {01, 0x14, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x06};
	
	//Is the device open?
	private static boolean devicePresent = false;
	private static boolean deviceConfigured = false;
	
	private int votesA = 0;
	private int votesB = 0;
	private int votesC = 0;
	private int votesD = 0;
	private int votesE = 0;
	private int[] allVotes;
	
	private WebController web;
	private Display display;
	
	private HidDevice dev;
	
	/**
	 * Runs a loop to connect to Pi and then control display 
	 * 
	 * @param args none expected
	 */
	public USBController(WebController web, Display display) {
		this.web = web;
		this.display = display;
		
		Thread t = new Thread(new Runnable() { public void run() { 
			try {
				//Screenshot screenshotController = new Screenshot();
				while(true) {
					//Scan for device when it's not open
					if(!devicePresent) {
						
						//Get list of all devices
						List<HidDeviceInfo> devList = PureJavaHidApi.enumerateDevices();
						HidDeviceInfo devInfo = null;
						
						//Loop through list of devices, look for PiClicker
						for (HidDeviceInfo info : devList) {
							if (info.getVendorId() == PICLICKER_VID && info.getProductId() == PICLICKER_PID) {
								// Save PiClicker's info. Change display to connected
								devInfo = info;
								System.out.println("Device found.");
								devicePresent = true;
								break;
							}
						}
						
						//If the device is open, configure it
						if(devicePresent && !deviceConfigured) {
							dev = PureJavaHidApi.openDevice(devInfo);
							
							startup();
							Thread.sleep(250);
							startSession();
							
							//Give it an InputReportListener
							dev.setInputReportListener(new InputReportListener() {
								@Override
								public void onInputReport(HidDevice source, byte Id, byte[] data, int len) {
									//Print out the report
									System.out.printf("onInputReport: id %d len %d data ", Id, len);
									for (int i = 0; i < len; i++) {
										System.out.printf("%02X ", data[i]);
									}
									System.out.println();
									
									//Check the first byte of the report and act accordingly
									if(data[0] == BYTE_OPEN) {
										//display.openDisplay();
									}
									else if (data[0] == BYTE_CLOSE) {
										//display.closeDisplay();
									}
									else if (data[0] == BYTE_NEXT_QUESTION) {
										Display.nextQuestion();
									}
									else if (data[0] == BYTE_SCREENSHOT) {
										//screenshotController.newScreenshot();
									}
									else if(data[0] == BYTE_SAVE_ALL_SCREENSHOTS) {
										//screenshotController.saveAllScreenshots(source);
									}
									else if(data[0] == BYTE_RESPONSE_ONE && data[1] == BYTE_RESPONSE_TWO) {
										//Get bytes responsible for ID
										byte[] idArr = Arrays.copyOfRange(data, 5, 8);
// need to switch to display, web	
										String idStr = "";
										//Add each byte to idStr
										for(int i = 0; i < idArr.length; i ++) {
											idStr += String.format("%02X", idArr[i]);
										}
					
										System.out.println(idStr);
										
										//Get byte responsible for response
										byte responseByte = data[4];
										//Convert byte to string
										String responseStr = String.format("%02X", responseByte);
										//Parse string to int
										int responseInt = Integer.parseInt(responseStr);
										//Get choice equivalent of int
										String responseLetter = "";
										switch (responseInt) {
											case 81:
												responseLetter = A;
												votesA++;
												break;
											case 82:
												responseLetter = B;
												votesB++;
												break;
											case 83:
												responseLetter = C;
												votesC++;
												break;
											case 84:
												responseLetter = D;
												votesD++;
												break;
											case 85:
												responseLetter = E;
												votesE++;
												break;
										}
										
										//Register the response
										//display.newResponse(idStr, responseLetter);
									}
								}
							});
							
							dev.setDeviceRemovalListener(new DeviceRemovalListener() {
								@Override
								public void onDeviceRemoval(HidDevice source) {
									System.out.println("Device removed.");
									devicePresent = false;
									deviceConfigured = false;
									dev = null;
									//Display.setConnected(false);
								}
							});
							
							deviceConfigured = true;
						}
					}
					
					//System.out.println("Failed to connect to USB.");
	
					Thread.sleep(500);
				}	
			} catch (Exception e) {
				e.printStackTrace();
			}
		}});
		
		t.start();
	}
	
	public void resetVotes() {
		votesA = 0;
		votesB = 0;
		votesC = 0;
		votesD = 0;
		votesE = 0;
	}
	
	public int[] getVotes() {
		allVotes = new int[] {votesA, votesB, votesC, votesD, votesE};
		return allVotes;
	}
	
	public int getNumVotes() {
		return votesA + votesB + votesC + votesD + votesE;
	}
	
	public void startPoll() {
		resetVotes();
		
		if(dev != null) {
			try {
				dev.setOutputReport((byte)0, START_POLL, START_POLL.length);
				dev.setOutputReport((byte)0, PACKET_01110000, PACKET_01110000.length);
			} catch (Exception e) {
				e.printStackTrace();
			}
		}
	}
	
	public void stopPoll() {
		if(dev != null) {
			try {
				dev.setOutputReport((byte)0, STOP_POLL, STOP_POLL.length);
			} catch (Exception e) {
				e.printStackTrace();
			}
		}
	}
	
	public void startup() {
		/*
		 * 01120000
		 * read
		 * 01320004
		 * read
		 * 011e0000
		 * read
		 * 01150000
		 * read
		 * 01220000
		 * read
		 * 01102141
		 * read
		 * 011e0000 
		 * read
		 * 01160000
		 * read
		 * 01136943
		 * 01142020
		 * */
		if(dev != null) {
			try {
				dev.setOutputReport((byte)0, PACKET_01120000, PACKET_01120000.length);
				dev.setOutputReport((byte)0, PACKET_01320004, PACKET_01320004.length);
				dev.setOutputReport((byte)0, PACKET_011e0000, PACKET_011e0000.length);
				dev.setOutputReport((byte)0, PACKET_01150000, PACKET_01150000.length);
				dev.setOutputReport((byte)0, PACKET_01220000, PACKET_01220000.length);
				dev.setOutputReport((byte)0, PACKET_01102141, PACKET_01102141.length);
				dev.setOutputReport((byte)0, PACKET_011e0000, PACKET_011e0000.length);
				dev.setOutputReport((byte)0, PACKET_01160000, PACKET_01160000.length);
				dev.setOutputReport((byte)0, PACKET_01136943, PACKET_01136943.length);
				dev.setOutputReport((byte)0, PACKET_01142020, PACKET_01142020.length);
				System.err.println("Completed startup!");
			} catch (Exception e) {
				e.printStackTrace();
			}
		}
	}
	
	public void startSession() {
		/*
		 * 01150000
		 * read
		 * 01120000
		 * read
		 * 011e0000
		 * read
		 * 01150000
		 * read
		 * 01220000
		 * read
		 * 01102141
		 * read
		 * 011e0000
		 * read
		 * 01160000
		 * read
		 * 01298080
		 * read
		 * 01150000
		 * read
		 * 01120000
		 * read
		 * 011e0000
		 * read
		 * 012a2141
		 * read
		 * read
		 * 01150000
		 * read
		 * 01220000
		 * read
		 * 01102141
		 * read
		 * 011e0000
		 * read
		 * 01160000
		 * read
		 * */
		if(dev != null) {
			try {
				dev.setOutputReport((byte)0, PACKET_01150000, PACKET_01150000.length);
				dev.setOutputReport((byte)0, PACKET_01120000, PACKET_01120000.length);
				dev.setOutputReport((byte)0, PACKET_011e0000, PACKET_011e0000.length);
				dev.setOutputReport((byte)0, PACKET_01150000, PACKET_01150000.length);
				dev.setOutputReport((byte)0, PACKET_01220000, PACKET_01220000.length);
				dev.setOutputReport((byte)0, PACKET_01102141, PACKET_01102141.length);
				dev.setOutputReport((byte)0, PACKET_011e0000, PACKET_011e0000.length);
				dev.setOutputReport((byte)0, PACKET_01160000, PACKET_01160000.length);
				dev.setOutputReport((byte)0, PACKET_01298080, PACKET_01298080.length);
				dev.setOutputReport((byte)0, PACKET_01150000, PACKET_01150000.length);
				dev.setOutputReport((byte)0, PACKET_01120000, PACKET_01120000.length);
				dev.setOutputReport((byte)0, PACKET_011e0000, PACKET_011e0000.length);
				dev.setOutputReport((byte)0, PACKET_012a2141, PACKET_012a2141.length);
				dev.setOutputReport((byte)0, PACKET_01150000, PACKET_01150000.length);
				dev.setOutputReport((byte)0, PACKET_01220000, PACKET_01220000.length);
				dev.setOutputReport((byte)0, PACKET_01102141, PACKET_01102141.length);
				dev.setOutputReport((byte)0, PACKET_011e0000, PACKET_011e0000.length);
				dev.setOutputReport((byte)0, PACKET_01160000, PACKET_01160000.length);
				System.err.println("Completed start session!");
			} catch (Exception e) {
				e.printStackTrace();
			}
		}
	}
	
	// time is in seconds
	private byte[] getTimeReport(int time, int totalVotes) {
		String minutes = "" + (time / 60) % 60;
		String seconds = "" + time % 60;
		
		String votes = "" + totalVotes;
		while(votes.length() < 5) {
			votes = " " + votes;
		}
		
		byte[] output = {0x01, 0x13, (byte) minutes.charAt(0), (byte) minutes.charAt(1), 0x3a, (byte) seconds.charAt(0), (byte) seconds.charAt(1), 0x20, 0x4e, 0x55, 0x4d, 0x20, 0x20, (byte) votes.charAt(0), (byte) votes.charAt(1), (byte) votes.charAt(2), (byte) votes.charAt(3), (byte) votes.charAt(4), 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, (byte) 0xa0};
		return output;
	}
}